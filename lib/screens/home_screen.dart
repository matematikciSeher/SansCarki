import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';
import '../models/task.dart';
import '../models/user_profile.dart';
import '../models/category.dart';
import '../data/task_data.dart';
import '../data/category_tasks.dart';
import '../widgets/fortune_wheel.dart';
import '../widgets/category_wheel.dart';
import '../widgets/task_card.dart';
import '../widgets/profile_page.dart';

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  int _currentIndex = 0;
  UserProfile _profile = UserProfile();
  List<Task> _completedTasks = [];
  Category? _selectedCategory;
  bool _showTaskWheel = false;

  @override
  void initState() {
    super.initState();
    _loadProfile();
    _loadCompletedTasks();
  }

  Future<void> _loadProfile() async {
    final prefs = await SharedPreferences.getInstance();
    final profileJson = prefs.getString('user_profile');
    if (profileJson != null) {
      setState(() {
        _profile = UserProfile.fromJson(json.decode(profileJson));
      });
    }
  }

  Future<void> _saveProfile() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('user_profile', json.encode(_profile.toJson()));
  }

  Future<void> _loadCompletedTasks() async {
    final prefs = await SharedPreferences.getInstance();
    final tasksJson = prefs.getStringList('completed_tasks') ?? [];
    setState(() {
      _completedTasks = tasksJson
          .map((json) => Task.fromJson(jsonDecode(json)))
          .toList();
    });
  }

  Future<void> _saveCompletedTasks() async {
    final prefs = await SharedPreferences.getInstance();
    final tasksJson = _completedTasks
        .map((task) => jsonEncode(task.toJson()))
        .toList();
    await prefs.setStringList('completed_tasks', tasksJson);
  }

  void _onCategorySelected(Category category) {
    setState(() {
      _selectedCategory = category;
      _showTaskWheel = true;
    });
  }

  void _onTaskSelected(Task task) {
    // G√∂rev se√ßildiƒüinde direkt tamamla
    _completeTask(task);

    // G√∂rev tamamlandƒ±ktan sonra kategori se√ßimine geri d√∂n
    setState(() {
      _showTaskWheel = false;
      _selectedCategory = null;
    });
  }

  void _completeTask(Task task) {
    final completedTask = task.copyWith(
      isCompleted: true,
      completedAt: DateTime.now(),
    );

    setState(() {
      _completedTasks.insert(0, completedTask);
      _profile = _profile.copyWith(
        points: _profile.points + 10,
        completedTasks: _profile.completedTasks + 1,
        streakDays: _profile.streakDays + 1,
        lastSpinDate: DateTime.now(),
      );

      // Kategori istatistiklerini g√ºncelle
      final categoryKey = task.category.toString();
      final currentCount = _profile.categoryStats[categoryKey] ?? 0;
      final newStats = Map<String, int>.from(_profile.categoryStats);
      newStats[categoryKey] = currentCount + 1;
      _profile = _profile.copyWith(categoryStats: newStats);

      // Rozet kontrol√º
      _checkAndAddBadges();
    });

    _saveProfile();
    _saveCompletedTasks();

    // Ba≈üarƒ± mesajƒ± g√∂ster
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.celebration, color: Colors.white),
            const SizedBox(width: 8),
            Text('G√∂rev tamamlandƒ±! +10 puan kazandƒ±n! üéâ'),
          ],
        ),
        backgroundColor: Colors.green,
        duration: const Duration(seconds: 3),
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
      ),
    );
  }

  void _checkAndAddBadges() {
    final newBadges = <String>[];
    final currentBadges = Set<String>.from(_profile.badges);

    // ƒ∞lk g√∂rev rozeti
    if (_profile.completedTasks == 1) {
      newBadges.add('üéØ ƒ∞lk G√∂rev');
    }

    // Seri g√ºn rozetleri
    if (_profile.streakDays == 7) {
      newBadges.add('üî• 7 G√ºn Seri');
    }
    if (_profile.streakDays == 30) {
      newBadges.add('üåü 30 G√ºn Seri');
    }

    // Puan rozetleri
    if (_profile.points >= 100 && !currentBadges.contains('üíé 100 Puan')) {
      newBadges.add('üíé 100 Puan');
    }
    if (_profile.points >= 500 && !currentBadges.contains('üèÜ 500 Puan')) {
      newBadges.add('üèÜ 500 Puan');
    }
    if (_profile.points >= 1000 && !currentBadges.contains('üëë 1000 Puan')) {
      newBadges.add('üëë 1000 Puan');
    }

    // Kategori rozetleri
    final categoryStats = _profile.categoryStats;
    if ((categoryStats[TaskCategory.creative.toString()] ?? 0) >= 5 &&
        !currentBadges.contains('üé® Yaratƒ±cƒ±')) {
      newBadges.add('üé® Yaratƒ±cƒ±');
    }
    if ((categoryStats[TaskCategory.active.toString()] ?? 0) >= 5 &&
        !currentBadges.contains('üí™ Aktif')) {
      newBadges.add('üí™ Aktif');
    }
    if ((categoryStats[TaskCategory.social.toString()] ?? 0) >= 5 &&
        !currentBadges.contains('ü§ù Sosyal')) {
      newBadges.add('ü§ù Sosyal');
    }
    if ((categoryStats[TaskCategory.challenge.toString()] ?? 0) >= 5 &&
        !currentBadges.contains('üòÑ Eƒülenceli')) {
      newBadges.add('üòÑ Eƒülenceli');
    }

    if (newBadges.isNotEmpty) {
      setState(() {
        _profile = _profile.copyWith(
          badges: [..._profile.badges, ...newBadges],
        );
      });

      // Rozet kazanma mesajƒ±
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              const Icon(Icons.emoji_events, color: Colors.white),
              const SizedBox(width: 8),
              Text('Yeni rozet kazandƒ±n: ${newBadges.first}! üèÜ'),
            ],
          ),
          backgroundColor: Colors.amber,
          duration: const Duration(seconds: 4),
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10),
          ),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'üéØ ≈ûans √áarkƒ±',
          style: TextStyle(fontWeight: FontWeight.bold, color: Colors.white),
        ),
        backgroundColor: Colors.orange,
        elevation: 0,
        centerTitle: true,
        actions: [
          if (_selectedCategory != null)
            IconButton(
              icon: const Icon(Icons.arrow_back),
              onPressed: () {
                setState(() {
                  _showTaskWheel = false;
                  _selectedCategory = null;
                });
              },
            ),
        ],
      ),
      body: IndexedStack(
        index: _currentIndex,
        children: [
          // Ana sayfa - √áark
          _buildWheelPage(),
          // Profil sayfasƒ±
          ProfilePage(profile: _profile, completedTasks: _completedTasks),
          // G√∂revler sayfasƒ±
          _buildTasksPage(),
        ],
      ),
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _currentIndex,
        onTap: (index) {
          setState(() {
            _currentIndex = index;
          });
        },
        selectedItemColor: Colors.orange,
        unselectedItemColor: Colors.grey,
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.casino), label: '√áark'),
          BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Profil'),
          BottomNavigationBarItem(
            icon: Icon(Icons.task_alt),
            label: 'G√∂revler',
          ),
        ],
      ),
    );
  }

  Widget _buildWheelPage() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          // Ho≈ü geldin mesajƒ±
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              gradient: const LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [Colors.orange, Colors.pink],
              ),
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: Colors.orange.withValues(alpha: 0.3),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              children: [
                const Text(
                  'üéâ Ho≈ü Geldin!',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  'Bug√ºn ${_profile.level} seviyesindesin!',
                  style: const TextStyle(fontSize: 16, color: Colors.white),
                ),
                const SizedBox(height: 8),
                Text(
                  '${_profile.points} puanƒ±n var',
                  style: const TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 32),

          // Se√ßilen kategori bilgisi
          if (_selectedCategory != null)
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    _selectedCategory!.color,
                    _selectedCategory!.color.withValues(alpha: 0.7),
                  ],
                ),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: _selectedCategory!.color.withValues(alpha: 0.3),
                    blurRadius: 20,
                    offset: const Offset(0, 10),
                  ),
                ],
              ),
              child: Column(
                children: [
                  Text(
                    _selectedCategory!.emoji,
                    style: const TextStyle(fontSize: 48),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    _selectedCategory!.name,
                    style: const TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    _selectedCategory!.description,
                    style: const TextStyle(fontSize: 16, color: Colors.white),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),

          const SizedBox(height: 32),

          // √áark sistemi
          if (!_showTaskWheel)
            CategoryWheel(
              onCategorySelected: _onCategorySelected,
              canSpin: true, // Test i√ßin her zaman √ßevirilebilir
            )
          else
            FortuneWheel(onTaskSelected: _onTaskSelected, canSpin: true),

          const SizedBox(height: 32),

          // G√ºnl√ºk motivasyon
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: Colors.blue.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(20),
              border: Border.all(
                color: Colors.blue.withValues(alpha: 0.3),
                width: 1,
              ),
            ),
            child: Column(
              children: [
                const Text(
                  'üí≠ G√ºnl√ºk Motivasyon',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.blue,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  _getDailyMotivation(),
                  style: const TextStyle(
                    fontSize: 16,
                    color: Colors.blue,
                    fontStyle: FontStyle.italic,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTasksPage() {
    return Column(
      children: [
        // Ba≈ülƒ±k
        Container(
          width: double.infinity,
          padding: const EdgeInsets.all(20),
          decoration: BoxDecoration(
            gradient: const LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [Colors.green, Colors.blue],
            ),
          ),
          child: const Column(
            children: [
              Text(
                'üìã T√ºm G√∂revler',
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                ),
              ),
              SizedBox(height: 8),
              Text(
                'Kategorilere g√∂re d√ºzenlenmi≈ü g√∂revler!',
                style: TextStyle(fontSize: 16, color: Colors.white),
              ),
            ],
          ),
        ),

        // Kategori se√ßimi
        Container(
          height: 60,
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: ListView.builder(
            scrollDirection: Axis.horizontal,
            itemCount: CategoryData.getAllCategories().length + 1,
            itemBuilder: (context, index) {
              if (index == 0) {
                return _buildCategoryChip(null, 'T√ºm√º', 'üîç', Colors.grey);
              }
              final category = CategoryData.getAllCategories()[index - 1];
              return _buildCategoryChip(
                category.id,
                category.name,
                category.emoji,
                category.color,
              );
            },
          ),
        ),

        // G√∂rev listesi
        Expanded(
          child: ListView.builder(
            padding: const EdgeInsets.all(16),
            itemCount: TaskData.getAllTasks().length,
            itemBuilder: (context, index) {
              final task = TaskData.getAllTasks()[index];
              final isCompleted = _completedTasks.any((t) => t.id == task.id);
              final completedTask = isCompleted
                  ? _completedTasks.firstWhere((t) => t.id == task.id)
                  : null;

              return TaskCard(
                task: completedTask ?? task,
                onComplete: isCompleted ? null : () => _completeTask(task),
                showCompleteButton: !isCompleted,
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildCategoryChip(
    String? categoryId,
    String name,
    String emoji,
    Color color,
  ) {
    return Container(
      margin: const EdgeInsets.only(right: 12),
      child: FilterChip(
        selected: false,
        label: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(emoji, style: const TextStyle(fontSize: 16)),
            const SizedBox(width: 4),
            Text(name),
          ],
        ),
        onSelected: (selected) {
          // Kategori filtreleme i≈ülemi burada yapƒ±labilir
        },
        backgroundColor: color.withValues(alpha: 0.1),
        selectedColor: color.withValues(alpha: 0.3),
        checkmarkColor: color,
      ),
    );
  }

  String _getDailyMotivation() {
    final motivations = [
      'Her g√ºn yeni bir ba≈ülangƒ±√ß! üåÖ',
      'K√º√ß√ºk adƒ±mlar b√ºy√ºk deƒüi≈üimler yaratƒ±r! üöÄ',
      'Bug√ºn harika bir g√ºn olacak! ‚ú®',
      'Kendine inan, her ≈üey m√ºmk√ºn! üí™',
      'G√ºl√ºmseme bula≈üƒ±cƒ±dƒ±r, yay! üòä',
      'Her g√∂rev seni daha g√º√ßl√º yapar! üéØ',
      '≈ûans seninle, sadece √ßarkƒ± √ßevir! üçÄ',
      'Bug√ºn kendine bir iyilik yap! üíñ',
    ];

    final today = DateTime.now();
    final index = today.day % motivations.length;
    return motivations[index];
  }

  @override
  void dispose() {
    super.dispose();
  }
}
